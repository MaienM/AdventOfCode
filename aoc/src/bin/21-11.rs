puzzle_runner::register_chapter!(book = "2021", title = "Dumbo Octopus");

use std::collections::HashSet;

use puzzle_lib::{grid::FullGrid, point::Point2};

type Grid = FullGrid<i8>;

fn parse_input(input: &str) -> Grid {
    parse!(input => { [grid cells as i8] } => grid)
}

fn do_round(grid: &mut Grid) -> u16 {
    grid.iter_mut_data().for_each(|level| *level += 1);

    let mut flashed: HashSet<Point2> = HashSet::new();
    loop {
        let should_flash = grid
            .iter_pairs()
            .filter(|(point, level)| !flashed.contains(point) && **level > 9)
            .map(|(point, _)| *point)
            .collect::<Vec<_>>();

        if should_flash.is_empty() {
            break;
        }

        for point in should_flash {
            flashed.insert(point);
            for (_, level) in grid.get_many_mut(point.neighbours_diag().iter()) {
                if let Some(level) = level {
                    *level += 1;
                }
            }
        }
    }

    let flash_count = flashed.len() as u16;

    for point in flashed {
        grid[point] = 0;
    }

    flash_count
}

pub fn part1(input: &str) -> u16 {
    let mut grid = parse_input(input);
    let mut flashes = 0u16;
    for _ in 0..100 {
        flashes += do_round(&mut grid);
    }
    flashes
}

pub fn part2(input: &str) -> u16 {
    let mut grid = parse_input(input);
    for round in 1.. {
        if do_round(&mut grid) == 100 {
            return round;
        }
    }
    panic!("How did you get here?");
}

#[cfg(test)]
mod tests {
    use pretty_assertions::assert_eq;
    use puzzle_runner::example_input;

    use super::*;

    #[example_input(part1 = 1656, part2 = 195)]
    static EXAMPLE_INPUT: &str = "
        5483143223
        2745854711
        5264556173
        6141336146
        6357385478
        4167524645
        2176841721
        6882881134
        4846848554
        5283751526
    ";

    #[test]
    fn example_parse() {
        let actual = parse_input(&EXAMPLE_INPUT);
        let expected: Grid = [
            [5, 4, 8, 3, 1, 4, 3, 2, 2, 3],
            [2, 7, 4, 5, 8, 5, 4, 7, 1, 1],
            [5, 2, 6, 4, 5, 5, 6, 1, 7, 3],
            [6, 1, 4, 1, 3, 3, 6, 1, 4, 6],
            [6, 3, 5, 7, 3, 8, 5, 4, 7, 8],
            [4, 1, 6, 7, 5, 2, 4, 6, 4, 5],
            [2, 1, 7, 6, 8, 4, 1, 7, 2, 1],
            [6, 8, 8, 2, 8, 8, 1, 1, 3, 4],
            [4, 8, 4, 6, 8, 4, 8, 5, 5, 4],
            [5, 2, 8, 3, 7, 5, 1, 5, 2, 6],
        ]
        .into();
        assert_eq!(actual, expected);
    }

    #[test]
    fn example_step_1() {
        let mut grid = [
            [5, 4, 8, 3, 1, 4, 3, 2, 2, 3],
            [2, 7, 4, 5, 8, 5, 4, 7, 1, 1],
            [5, 2, 6, 4, 5, 5, 6, 1, 7, 3],
            [6, 1, 4, 1, 3, 3, 6, 1, 4, 6],
            [6, 3, 5, 7, 3, 8, 5, 4, 7, 8],
            [4, 1, 6, 7, 5, 2, 4, 6, 4, 5],
            [2, 1, 7, 6, 8, 4, 1, 7, 2, 1],
            [6, 8, 8, 2, 8, 8, 1, 1, 3, 4],
            [4, 8, 4, 6, 8, 4, 8, 5, 5, 4],
            [5, 2, 8, 3, 7, 5, 1, 5, 2, 6],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 0);
        assert_eq!(
            grid,
            [
                [6, 5, 9, 4, 2, 5, 4, 3, 3, 4],
                [3, 8, 5, 6, 9, 6, 5, 8, 2, 2],
                [6, 3, 7, 5, 6, 6, 7, 2, 8, 4],
                [7, 2, 5, 2, 4, 4, 7, 2, 5, 7],
                [7, 4, 6, 8, 4, 9, 6, 5, 8, 9],
                [5, 2, 7, 8, 6, 3, 5, 7, 5, 6],
                [3, 2, 8, 7, 9, 5, 2, 8, 3, 2],
                [7, 9, 9, 3, 9, 9, 2, 2, 4, 5],
                [5, 9, 5, 7, 9, 5, 9, 6, 6, 5],
                [6, 3, 9, 4, 8, 6, 2, 6, 3, 7],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_2() {
        let mut grid = [
            [6, 5, 9, 4, 2, 5, 4, 3, 3, 4],
            [3, 8, 5, 6, 9, 6, 5, 8, 2, 2],
            [6, 3, 7, 5, 6, 6, 7, 2, 8, 4],
            [7, 2, 5, 2, 4, 4, 7, 2, 5, 7],
            [7, 4, 6, 8, 4, 9, 6, 5, 8, 9],
            [5, 2, 7, 8, 6, 3, 5, 7, 5, 6],
            [3, 2, 8, 7, 9, 5, 2, 8, 3, 2],
            [7, 9, 9, 3, 9, 9, 2, 2, 4, 5],
            [5, 9, 5, 7, 9, 5, 9, 6, 6, 5],
            [6, 3, 9, 4, 8, 6, 2, 6, 3, 7],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 35);
        assert_eq!(
            grid,
            [
                [8, 8, 0, 7, 4, 7, 6, 5, 5, 5],
                [5, 0, 8, 9, 0, 8, 7, 0, 5, 4],
                [8, 5, 9, 7, 8, 8, 9, 6, 0, 8],
                [8, 4, 8, 5, 7, 6, 9, 6, 0, 0],
                [8, 7, 0, 0, 9, 0, 8, 8, 0, 0],
                [6, 6, 0, 0, 0, 8, 8, 9, 8, 9],
                [6, 8, 0, 0, 0, 0, 5, 9, 4, 3],
                [0, 0, 0, 0, 0, 0, 7, 4, 5, 6],
                [9, 0, 0, 0, 0, 0, 0, 8, 7, 6],
                [8, 7, 0, 0, 0, 0, 6, 8, 4, 8],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_3() {
        let mut grid = [
            [8, 8, 0, 7, 4, 7, 6, 5, 5, 5],
            [5, 0, 8, 9, 0, 8, 7, 0, 5, 4],
            [8, 5, 9, 7, 8, 8, 9, 6, 0, 8],
            [8, 4, 8, 5, 7, 6, 9, 6, 0, 0],
            [8, 7, 0, 0, 9, 0, 8, 8, 0, 0],
            [6, 6, 0, 0, 0, 8, 8, 9, 8, 9],
            [6, 8, 0, 0, 0, 0, 5, 9, 4, 3],
            [0, 0, 0, 0, 0, 0, 7, 4, 5, 6],
            [9, 0, 0, 0, 0, 0, 0, 8, 7, 6],
            [8, 7, 0, 0, 0, 0, 6, 8, 4, 8],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 45);
        assert_eq!(
            grid,
            [
                [0, 0, 5, 0, 9, 0, 0, 8, 6, 6],
                [8, 5, 0, 0, 8, 0, 0, 5, 7, 5],
                [9, 9, 0, 0, 0, 0, 0, 0, 3, 9],
                [9, 7, 0, 0, 0, 0, 0, 0, 4, 1],
                [9, 9, 3, 5, 0, 8, 0, 0, 6, 3],
                [7, 7, 1, 2, 3, 0, 0, 0, 0, 0],
                [7, 9, 1, 1, 2, 5, 0, 0, 0, 9],
                [2, 2, 1, 1, 1, 3, 0, 0, 0, 0],
                [0, 4, 2, 1, 1, 2, 5, 0, 0, 0],
                [0, 0, 2, 1, 1, 1, 9, 0, 0, 0],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_4() {
        let mut grid = [
            [0, 0, 5, 0, 9, 0, 0, 8, 6, 6],
            [8, 5, 0, 0, 8, 0, 0, 5, 7, 5],
            [9, 9, 0, 0, 0, 0, 0, 0, 3, 9],
            [9, 7, 0, 0, 0, 0, 0, 0, 4, 1],
            [9, 9, 3, 5, 0, 8, 0, 0, 6, 3],
            [7, 7, 1, 2, 3, 0, 0, 0, 0, 0],
            [7, 9, 1, 1, 2, 5, 0, 0, 0, 9],
            [2, 2, 1, 1, 1, 3, 0, 0, 0, 0],
            [0, 4, 2, 1, 1, 2, 5, 0, 0, 0],
            [0, 0, 2, 1, 1, 1, 9, 0, 0, 0],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 16);
        assert_eq!(
            grid,
            [
                [2, 2, 6, 3, 0, 3, 1, 9, 7, 7],
                [0, 9, 2, 3, 0, 3, 1, 6, 9, 7],
                [0, 0, 3, 2, 2, 2, 1, 1, 5, 0],
                [0, 0, 4, 1, 1, 1, 1, 1, 6, 3],
                [0, 0, 7, 6, 1, 9, 1, 1, 7, 4],
                [0, 0, 5, 3, 4, 1, 1, 1, 2, 2],
                [0, 0, 4, 2, 3, 6, 1, 1, 2, 0],
                [5, 5, 3, 2, 2, 4, 1, 1, 2, 2],
                [1, 5, 3, 2, 2, 4, 7, 2, 1, 1],
                [1, 1, 3, 2, 2, 3, 0, 2, 1, 1],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_5() {
        let mut grid = [
            [2, 2, 6, 3, 0, 3, 1, 9, 7, 7],
            [0, 9, 2, 3, 0, 3, 1, 6, 9, 7],
            [0, 0, 3, 2, 2, 2, 1, 1, 5, 0],
            [0, 0, 4, 1, 1, 1, 1, 1, 6, 3],
            [0, 0, 7, 6, 1, 9, 1, 1, 7, 4],
            [0, 0, 5, 3, 4, 1, 1, 1, 2, 2],
            [0, 0, 4, 2, 3, 6, 1, 1, 2, 0],
            [5, 5, 3, 2, 2, 4, 1, 1, 2, 2],
            [1, 5, 3, 2, 2, 4, 7, 2, 1, 1],
            [1, 1, 3, 2, 2, 3, 0, 2, 1, 1],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 8);
        assert_eq!(
            grid,
            [
                [4, 4, 8, 4, 1, 4, 4, 0, 0, 0],
                [2, 0, 4, 4, 1, 4, 4, 0, 0, 0],
                [2, 2, 5, 3, 3, 3, 3, 4, 9, 3],
                [1, 1, 5, 2, 3, 3, 3, 2, 7, 4],
                [1, 1, 8, 7, 3, 0, 3, 2, 8, 5],
                [1, 1, 6, 4, 6, 3, 3, 2, 3, 3],
                [1, 1, 5, 3, 4, 7, 2, 2, 3, 1],
                [6, 6, 4, 3, 3, 5, 2, 2, 3, 3],
                [2, 6, 4, 3, 3, 5, 8, 3, 2, 2],
                [2, 2, 4, 3, 3, 4, 1, 3, 2, 2],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_6() {
        let mut grid = [
            [4, 4, 8, 4, 1, 4, 4, 0, 0, 0],
            [2, 0, 4, 4, 1, 4, 4, 0, 0, 0],
            [2, 2, 5, 3, 3, 3, 3, 4, 9, 3],
            [1, 1, 5, 2, 3, 3, 3, 2, 7, 4],
            [1, 1, 8, 7, 3, 0, 3, 2, 8, 5],
            [1, 1, 6, 4, 6, 3, 3, 2, 3, 3],
            [1, 1, 5, 3, 4, 7, 2, 2, 3, 1],
            [6, 6, 4, 3, 3, 5, 2, 2, 3, 3],
            [2, 6, 4, 3, 3, 5, 8, 3, 2, 2],
            [2, 2, 4, 3, 3, 4, 1, 3, 2, 2],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 1);
        assert_eq!(
            grid,
            [
                [5, 5, 9, 5, 2, 5, 5, 1, 1, 1],
                [3, 1, 5, 5, 2, 5, 5, 2, 2, 2],
                [3, 3, 6, 4, 4, 4, 4, 6, 0, 5],
                [2, 2, 6, 3, 4, 4, 4, 4, 9, 6],
                [2, 2, 9, 8, 4, 1, 4, 3, 9, 6],
                [2, 2, 7, 5, 7, 4, 4, 3, 4, 4],
                [2, 2, 6, 4, 5, 8, 3, 3, 4, 2],
                [7, 7, 5, 4, 4, 6, 3, 3, 4, 4],
                [3, 7, 5, 4, 4, 6, 9, 4, 3, 3],
                [3, 3, 5, 4, 4, 5, 2, 4, 3, 3],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_7() {
        let mut grid = [
            [5, 5, 9, 5, 2, 5, 5, 1, 1, 1],
            [3, 1, 5, 5, 2, 5, 5, 2, 2, 2],
            [3, 3, 6, 4, 4, 4, 4, 6, 0, 5],
            [2, 2, 6, 3, 4, 4, 4, 4, 9, 6],
            [2, 2, 9, 8, 4, 1, 4, 3, 9, 6],
            [2, 2, 7, 5, 7, 4, 4, 3, 4, 4],
            [2, 2, 6, 4, 5, 8, 3, 3, 4, 2],
            [7, 7, 5, 4, 4, 6, 3, 3, 4, 4],
            [3, 7, 5, 4, 4, 6, 9, 4, 3, 3],
            [3, 3, 5, 4, 4, 5, 2, 4, 3, 3],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 7);
        assert_eq!(
            grid,
            [
                [6, 7, 0, 7, 3, 6, 6, 2, 2, 2],
                [4, 3, 7, 7, 3, 6, 6, 3, 3, 3],
                [4, 4, 7, 5, 5, 5, 5, 8, 2, 7],
                [3, 4, 9, 6, 6, 5, 5, 7, 0, 9],
                [3, 5, 0, 0, 6, 2, 5, 6, 0, 9],
                [3, 5, 0, 9, 9, 5, 5, 5, 6, 6],
                [3, 4, 8, 6, 6, 9, 4, 4, 5, 3],
                [8, 8, 6, 5, 5, 8, 5, 5, 5, 5],
                [4, 8, 6, 5, 5, 8, 0, 6, 4, 4],
                [4, 4, 6, 5, 5, 7, 4, 6, 4, 4],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_8() {
        let mut grid = [
            [6, 7, 0, 7, 3, 6, 6, 2, 2, 2],
            [4, 3, 7, 7, 3, 6, 6, 3, 3, 3],
            [4, 4, 7, 5, 5, 5, 5, 8, 2, 7],
            [3, 4, 9, 6, 6, 5, 5, 7, 0, 9],
            [3, 5, 0, 0, 6, 2, 5, 6, 0, 9],
            [3, 5, 0, 9, 9, 5, 5, 5, 6, 6],
            [3, 4, 8, 6, 6, 9, 4, 4, 5, 3],
            [8, 8, 6, 5, 5, 8, 5, 5, 5, 5],
            [4, 8, 6, 5, 5, 8, 0, 6, 4, 4],
            [4, 4, 6, 5, 5, 7, 4, 6, 4, 4],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 24);
        assert_eq!(
            grid,
            [
                [7, 8, 1, 8, 4, 7, 7, 3, 3, 3],
                [5, 4, 8, 8, 4, 7, 7, 4, 4, 4],
                [5, 6, 9, 7, 6, 6, 6, 9, 4, 9],
                [4, 6, 0, 8, 7, 6, 6, 8, 3, 0],
                [4, 7, 3, 4, 9, 4, 6, 7, 3, 0],
                [4, 7, 4, 0, 0, 9, 7, 6, 8, 8],
                [6, 9, 0, 0, 0, 0, 7, 5, 6, 4],
                [0, 0, 0, 0, 0, 0, 9, 6, 6, 6],
                [8, 0, 0, 0, 0, 0, 4, 7, 5, 5],
                [6, 8, 0, 0, 0, 0, 7, 7, 5, 5],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_9() {
        let mut grid = [
            [7, 8, 1, 8, 4, 7, 7, 3, 3, 3],
            [5, 4, 8, 8, 4, 7, 7, 4, 4, 4],
            [5, 6, 9, 7, 6, 6, 6, 9, 4, 9],
            [4, 6, 0, 8, 7, 6, 6, 8, 3, 0],
            [4, 7, 3, 4, 9, 4, 6, 7, 3, 0],
            [4, 7, 4, 0, 0, 9, 7, 6, 8, 8],
            [6, 9, 0, 0, 0, 0, 7, 5, 6, 4],
            [0, 0, 0, 0, 0, 0, 9, 6, 6, 6],
            [8, 0, 0, 0, 0, 0, 4, 7, 5, 5],
            [6, 8, 0, 0, 0, 0, 7, 7, 5, 5],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 39);
        assert_eq!(
            grid,
            [
                [9, 0, 6, 0, 0, 0, 0, 6, 4, 4],
                [7, 8, 0, 0, 0, 0, 0, 9, 7, 6],
                [6, 9, 0, 0, 0, 0, 0, 0, 8, 0],
                [5, 8, 4, 0, 0, 0, 0, 0, 8, 2],
                [5, 8, 5, 8, 0, 0, 0, 0, 9, 3],
                [6, 9, 6, 2, 4, 0, 0, 0, 0, 0],
                [8, 0, 2, 1, 2, 5, 0, 0, 0, 9],
                [2, 2, 2, 1, 1, 3, 0, 0, 0, 9],
                [9, 1, 1, 1, 1, 2, 8, 0, 9, 7],
                [7, 9, 1, 1, 1, 1, 9, 9, 7, 6],
            ]
            .into()
        );
    }

    #[test]
    fn example_step_10() {
        let mut grid = [
            [9, 0, 6, 0, 0, 0, 0, 6, 4, 4],
            [7, 8, 0, 0, 0, 0, 0, 9, 7, 6],
            [6, 9, 0, 0, 0, 0, 0, 0, 8, 0],
            [5, 8, 4, 0, 0, 0, 0, 0, 8, 2],
            [5, 8, 5, 8, 0, 0, 0, 0, 9, 3],
            [6, 9, 6, 2, 4, 0, 0, 0, 0, 0],
            [8, 0, 2, 1, 2, 5, 0, 0, 0, 9],
            [2, 2, 2, 1, 1, 3, 0, 0, 0, 9],
            [9, 1, 1, 1, 1, 2, 8, 0, 9, 7],
            [7, 9, 1, 1, 1, 1, 9, 9, 7, 6],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 29);
        assert_eq!(
            grid,
            [
                [0, 4, 8, 1, 1, 1, 2, 9, 7, 6],
                [0, 0, 3, 1, 1, 1, 2, 0, 0, 9],
                [0, 0, 4, 1, 1, 1, 2, 5, 0, 4],
                [0, 0, 8, 1, 1, 1, 1, 4, 0, 6],
                [0, 0, 9, 9, 1, 1, 1, 3, 0, 6],
                [0, 0, 9, 3, 5, 1, 1, 2, 3, 3],
                [0, 4, 4, 2, 3, 6, 1, 1, 3, 0],
                [5, 5, 3, 2, 2, 5, 2, 3, 5, 0],
                [0, 5, 3, 2, 2, 5, 0, 6, 0, 0],
                [0, 0, 3, 2, 2, 4, 0, 0, 0, 0],
            ]
            .into()
        );
    }

    #[test]
    fn example_small_1() {
        let mut grid = [
            [1, 1, 1, 1, 1],
            [1, 9, 9, 9, 1],
            [1, 9, 1, 9, 1],
            [1, 9, 9, 9, 1],
            [1, 1, 1, 1, 1],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 9);
        assert_eq!(
            grid,
            [
                [3, 4, 5, 4, 3],
                [4, 0, 0, 0, 4],
                [5, 0, 0, 0, 5],
                [4, 0, 0, 0, 4],
                [3, 4, 5, 4, 3],
            ]
            .into()
        );
    }

    #[test]
    fn example_small_2() {
        let mut grid = [
            [3, 4, 5, 4, 3],
            [4, 0, 0, 0, 4],
            [5, 0, 0, 0, 5],
            [4, 0, 0, 0, 4],
            [3, 4, 5, 4, 3],
        ]
        .into();
        let actual_steps = do_round(&mut grid);
        assert_eq!(actual_steps, 0);
        assert_eq!(
            grid,
            [
                [4, 5, 6, 5, 4],
                [5, 1, 1, 1, 5],
                [6, 1, 1, 1, 6],
                [5, 1, 1, 1, 5],
                [4, 5, 6, 5, 4],
            ]
            .into()
        );
    }
}
